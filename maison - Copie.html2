<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Studio Domotique 360 PRO - VAR</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --accent: #00d1ff; }
        body { background-color: #000; margin: 0; overflow: hidden; font-family: sans-serif; color: white; }
        #side-menu { position: fixed; top: 0; left: -250px; width: 250px; height: 100%; background: rgba(20,20,20,0.95); z-index: 2000; transition: 0.3s; border-right: 1px solid #333; padding: 20px; }
        #side-menu.open { left: 0; }
        .room-item { padding: 12px; border-radius: 8px; cursor: pointer; margin-bottom: 5px; }
        .room-item.active { background: var(--accent); color: black; font-weight: bold; }
        #top-info { position: fixed; top: 10px; left: 50%; transform: translateX(-50%); z-index: 1000; text-align: center; pointer-events: none; }
        #room-name { font-weight: bold; font-size: 1.2rem; color: var(--accent); text-transform: uppercase; }
        #plan-wrapper { position: relative; height: 100vh; width: 100vw; display: flex; align-items: center; justify-content: center; }
        #panorama { position: absolute; width: 100%; height: 100%; display: none; z-index: 500; }
        #plan-container { position: relative; z-index: 10; }
        #plan-img { max-height: 85vh; max-width: 95vw; display: block; user-select: none; }
        svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 20; }
        svg.edit-active { pointer-events: all !important; }
        .zone-poly { fill: var(--accent); fill-opacity: 0.1; stroke: var(--accent); stroke-width: 1; cursor: pointer; pointer-events: all; }
        .zone-poly:hover { fill-opacity: 0.4; stroke: white; stroke-width: 2; }
        #draw-line { stroke: #ff4444; stroke-width: 2; fill: rgba(255, 68, 68, 0.2); stroke-dasharray: 5; pointer-events: none; }
        .btn-menu { position: fixed; top: 20px; left: 20px; z-index: 2100; background: rgba(0,0,0,0.6); border: 1px solid var(--accent); color: white; border-radius: 50%; width: 45px; height: 45px; }
        .ui-controls { position: fixed; bottom: 20px; right: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; }
        #ha-modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 400px; height: 600px; background: #1c1c1c; border-radius: 20px; z-index: 3000; border: 1px solid #444; }
        #modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2999; }
        .close-btn { position: absolute; top: 15px; right: 20px; font-size: 30px; color: white; cursor: pointer; }
        .custom-hotspot { height: 25px; width: 25px; background: rgba(0, 209, 255, 0.7); border: 2px solid white; border-radius: 50%; cursor: pointer; }
    </style>
</head>
<body>

<div id="side-menu">
    <h4 class="mb-4 mt-5">Pi√®ces</h4>
    <div id="rooms-list"></div>
</div>

<button class="btn-menu" onclick="document.getElementById('side-menu').classList.toggle('open')"><i class="fas fa-bars"></i></button>

<div id="top-info">
    <div id="room-name">...</div>
    <div id="temp-badge" class="badge bg-dark border border-info mt-1">--¬∞C</div>
</div>

<div class="ui-controls">
    <button id="btn-toggle-360" class="btn btn-info btn-sm rounded-pill fw-bold px-3 shadow" onclick="toggle360View()">VUE 360¬∞</button>
    <button id="btn-edit" class="btn btn-warning btn-sm rounded-pill" onclick="toggleEdit()">√âDIT</button>
    <button id="btn-save" class="btn btn-success btn-sm rounded-pill d-none" onclick="saveToHA()">SAUVER</button>
</div>

<div id="plan-wrapper">
    <div id="panorama"></div>
    <div id="plan-container">
        <img src="" id="plan-img">
        <svg id="svg-overlay" onclick="handleMapClick(event)">
            <polygon id="draw-line" points=""></polygon>
        </svg>
    </div>
</div>

<div id="modal-overlay" onclick="closeModal()"></div>
<div id="ha-modal"><span class="close-btn" onclick="closeModal()">&times;</span><iframe id="ha-frame" style="width:100%; height:100%; border:none;"></iframe></div>

<div class="modal fade" id="configModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered text-dark">
        <div class="modal-content"><div class="modal-body">
            <h6>R√©glage</h6>
            <input type="hidden" id="edit-idx"><input type="hidden" id="edit-type">
            <input type="text" id="zone-name" class="form-control mb-2" placeholder="Nom">
            <input type="text" id="zone-url" class="form-control" placeholder="Entit√© ou URL">
            <small class="text-muted">üí° VAR activ√© - Plus de limite de 255 caract√®res !</small>
            <div class="d-flex gap-2 mt-3">
                <button class="btn btn-danger w-50" onclick="deleteItem()">Suppr</button>
                <button class="btn btn-primary w-50" onclick="confirmItem()">OK</button>
            </div>
        </div></div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"></script>

<script>
const HA_URL = "https://qq5e0tspgj2a22alvsqitgptzj2sz0o4.ui.nabu.casa";
const TOKEN = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiIyM2QwMGZhNDdhYzM0NTgzYmFlM2UzMGRiMWMwMzBjMyIsImlhdCI6MTc2OTQyNzk1MiwiZXhwIjoyMDg0Nzg3OTUyfQ.qCik3fu6D-CqVg6RVuoQjF4g8zbM2ZXtYu3LVxrGVEs";

const ROOMS = [
    { n: "Cuisine", img: "Cuisine.jpg", img360: "Cuisine__1.jpg", store: "var.plan_cuisine_data", store360: "var.plan_cuisine_360", temp: "sensor.temperature_cuisine_2" },
    { n: "Salon", img: "Salon.jpg", store: "var.plan_salon_data", temp: "sensor.temp_salon" },
    { n: "Elisa", img: "Elisa.jpg", store: "var.plan_chambre1_data", temp: "sensor.current_temperature_chambre_elisa" },
    { n: "Justine", img: "Justine.jpg", store: "var.plan_chambre2_data", temp: "sensor.sensor_temp_justine" },
    { n: "Parents", img: "Chambreparents.jpg", store: "var.plan_chambre3_data", temp: "sensor.current_temperature_chambre_parent" }
];

let curR = 0, zones = [], hotspots = [], currentPoints = [], editMode = false, is360Active = false, panoViewer = null;
const bModal = new bootstrap.Modal(document.getElementById('configModal'));
const headers = { "Authorization": `Bearer ${TOKEN}`, "Content-Type": "application/json" };

function initMenu() {
    document.getElementById('rooms-list').innerHTML = ROOMS.map((r, i) => `
        <div class="room-item ${i === curR ? 'active' : ''}" onclick="switchRoom(${i}); document.getElementById('side-menu').classList.remove('open');">
            <i class="fas fa-door-open me-2"></i> ${r.n}
        </div>`).join('');
}

function handleMapClick(e) {
    if(!editMode || is360Active) return;
    const img = document.getElementById('plan-img');
    const rect = img.getBoundingClientRect();
    const x = Math.round(((e.clientX - rect.left) / rect.width) * 100);
    const y = Math.round(((e.clientY - rect.top) / rect.height) * 100);
    currentPoints.push(`${x},${y}`);
    updateDrawLine();
}

function updateDrawLine() {
    const img = document.getElementById('plan-img');
    const rect = img.getBoundingClientRect();
    const pts = currentPoints.map(p => {
        const [px, py] = p.split(',');
        return `${(px * rect.width) / 100},${(py * rect.height) / 100}`;
    }).join(' ');
    document.getElementById('draw-line').setAttribute("points", pts);
}

window.onkeydown = (e) => {
    if(e.key === "Enter" && currentPoints.length > 2) {
        zones.push({ n: "Nouveau", p: currentPoints.join(' '), u: "" });
        currentPoints = [];
        document.getElementById('draw-line').setAttribute("points", "");
        drawZones();
        openConfig(zones.length - 1, '2D');
    }
};

function drawZones() {
    const svg = document.getElementById('svg-overlay');
    const img = document.getElementById('plan-img');
    const line = document.getElementById('draw-line');
    svg.innerHTML = ''; svg.appendChild(line);
    zones.forEach((z, i) => {
        const poly = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
        const pts = z.p.split(' ').map(p => {
            const [px, py] = p.split(',');
            return `${px * img.clientWidth / 100},${py * img.clientHeight / 100}`;
        }).join(' ');
        poly.setAttribute("points", pts);
        poly.setAttribute("class", "zone-poly");
        poly.onclick = (e) => { e.stopPropagation(); editMode ? openConfig(i, '2D') : handleAction(z); };
        svg.appendChild(poly);
    });
}

function initPannellum() {
    if(panoViewer) panoViewer.destroy();
    
    console.log("Initializing Pannellum with hotspots:", hotspots);
    
    panoViewer = pannellum.viewer('panorama', {
        "type": "equirectangular", 
        "panorama": ROOMS[curR].img360, 
        "autoLoad": true, 
        "showControls": false,
        "hotSpots": hotspots.map((h, i) => ({
            pitch: parseFloat(h.pi), 
            yaw: parseFloat(h.y), 
            cssClass: 'custom-hotspot',
            clickHandlerFunc: () => editMode ? openConfig(i, '360') : handleAction(h)
        }))
    });
    
    panoViewer.on('mousedown', (e) => {
        if(!editMode) return;
        const c = panoViewer.mouseEventToCoords(e);
        if(c) {
            hotspots.push({ n: "Point", pi: Math.round(c[0]), y: Math.round(c[1]), u: "" });
            initPannellum();
            setTimeout(() => openConfig(hotspots.length - 1, '360'), 200);
        }
    });
}

async function switchRoom(idx) {
    curR = idx; 
    const r = ROOMS[curR];
    document.getElementById('room-name').innerText = r.n;
    document.getElementById('plan-img').src = r.img;
    initMenu();
    
    try {
        // Chargement 2D depuis VAR
        const s = await fetch(`${HA_URL}/api/states/${r.store}`, { headers });
        const sData = await s.json();
        console.log("Donn√©es 2D re√ßues:", sData);
        const raw2d = (sData.state && sData.state !== "unknown" && sData.state !== "") ? JSON.parse(sData.state) : [];
        zones = raw2d.map(z => ({ n: z.n || z.name, p: z.p || z.points, u: z.u || z.url }));
        
        // Chargement 360 depuis VAR
        if(r.store360) {
            const h = await fetch(`${HA_URL}/api/states/${r.store360}`, { headers });
            const hData = await h.json();
            console.log("Donn√©es 360 re√ßues:", hData);
            const raw360 = (hData.state && hData.state !== "unknown" && hData.state !== "") ? JSON.parse(hData.state) : [];
            hotspots = raw360.map(hs => ({ n: hs.n || hs.name, pi: hs.pi || hs.pitch, y: hs.y || hs.yaw, u: hs.u || hs.url }));
            console.log("Hotspots charg√©s:", hotspots);
        } else {
            hotspots = [];
        }
        
        // Temp√©rature
        const t = await fetch(`${HA_URL}/api/states/${r.temp}`, { headers });
        const tData = await t.json();
        document.getElementById('temp-badge').innerText = `${tData.state || '--'}¬∞C`;
    } catch(e) {
        console.error("Erreur chargement:", e);
    }
    
    is360Active ? initPannellum() : syncSVG();
}

async function saveToHA() {
    const r = ROOMS[curR];
    
    // Avec VAR, on garde les noms complets (pas de limitation √† 8 caract√®res)
    const cleanZones = zones.map(z => ({ n: z.n, p: z.p, u: z.u }));
    const cleanHotspots = hotspots.map(h => ({ n: h.n, pi: Math.round(h.pi), y: Math.round(h.y), u: h.u }));
    
    const val2d = JSON.stringify(cleanZones);
    const val360 = JSON.stringify(cleanHotspots);

    console.log(`üìä Sauvegarde VAR:\n2D: ${val2d.length} caract√®res (${zones.length} zones)\n360: ${val360.length} caract√®res (${hotspots.length} hotspots)`);

    try {
        // Service correct : var.set
        await fetch(`${HA_URL}/api/services/var/set`, {
            method:'POST', 
            headers, 
            body:JSON.stringify({entity_id: r.store, value: val2d})
        });
        
        if(r.store360) {
            await fetch(`${HA_URL}/api/services/var/set`, {
                method:'POST', 
                headers, 
                body:JSON.stringify({entity_id: r.store360, value: val360})
            });
        }
        
        alert(`‚úÖ Sauvegard√© avec VAR!\n\n2D: ${val2d.length} car. (${zones.length} zones)\n360: ${val360.length} car. (${hotspots.length} hotspots)`);
    } catch(e) { 
        console.error("Erreur sauvegarde:", e);
        alert("‚ùå Erreur de sauvegarde"); 
    }
}

function toggle360View() {
    is360Active = !is360Active;
    document.getElementById('panorama').style.display = is360Active ? 'block' : 'none';
    document.getElementById('plan-container').style.display = is360Active ? 'none' : 'block';
    document.getElementById('btn-toggle-360').innerText = is360Active ? "PLAN 2D" : "VUE 360¬∞";
    is360Active ? initPannellum() : syncSVG();
}

function toggleEdit() {
    editMode = !editMode;
    document.getElementById('btn-edit').innerText = editMode ? "FINIR" : "√âDIT";
    document.getElementById('btn-save').classList.toggle('d-none', !editMode);
    document.getElementById('svg-overlay').classList.toggle('edit-active', editMode);
    currentPoints = []; 
    updateDrawLine();
}

function openConfig(idx, type) {
    document.getElementById('edit-idx').value = idx;
    document.getElementById('edit-type').value = type;
    const item = (type === '360') ? hotspots[idx] : zones[idx];
    document.getElementById('zone-name').value = item.n;
    document.getElementById('zone-url').value = item.u;
    bModal.show();
}

function confirmItem() {
    const i = document.getElementById('edit-idx').value;
    const type = document.getElementById('edit-type').value;
    const item = (type === '360') ? hotspots[i] : zones[i];
    item.n = document.getElementById('zone-name').value;
    item.u = document.getElementById('zone-url').value;
    bModal.hide();
    is360Active ? initPannellum() : drawZones();
}

function deleteItem() {
    const i = document.getElementById('edit-idx').value;
    if(document.getElementById('edit-type').value === '360') {
        hotspots.splice(i, 1);
    } else {
        zones.splice(i, 1);
    }
    bModal.hide();
    is360Active ? initPannellum() : drawZones();
}

async function handleAction(item) {
    const url = item.u || item.url;
    if(!url) return;
    
    if(url.includes('.') && !url.includes('/')) {
        // C'est une entit√© Home Assistant
        await fetch(`${HA_URL}/api/services/homeassistant/toggle`, { 
            method: 'POST', 
            headers, 
            body: JSON.stringify({ entity_id: url }) 
        });
    } else {
        // C'est une URL
        document.getElementById('ha-frame').src = url;
        document.getElementById('ha-modal').style.display = 'block';
        document.getElementById('modal-overlay').style.display = 'block';
    }
}

function closeModal() { 
    document.getElementById('ha-modal').style.display='none'; 
    document.getElementById('modal-overlay').style.display='none'; 
}

function syncSVG() {
    const img = document.getElementById('plan-img');
    const svg = document.getElementById('svg-overlay');
    if(!img.clientWidth) return;
    svg.setAttribute("viewBox", `0 0 ${img.clientWidth} ${img.clientHeight}`);
    svg.style.width = img.clientWidth + "px"; 
    svg.style.height = img.clientHeight + "px";
    drawZones();
}

// Initialisation
switchRoom(0);
window.onresize = syncSVG;
document.getElementById('plan-img').onload = syncSVG;
</script>
</body>
</html>